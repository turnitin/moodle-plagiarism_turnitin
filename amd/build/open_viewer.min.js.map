{"version":3,"sources":["../src/open_viewer.js"],"names":["define","$","origreport_open","that","document","on","classList","attr","replace","split","i","length","indexOf","classStr","openDV","grademark_open","dvtype","submissionid","coursemoduleid","dvWindow","window","open","loading","M","cfg","wwwroot","str","plagiarism_turnitin","loadingdv","body","html","ajax","type","url","dataType","data","action","cmid","sesskey","success","forms","submit","close","checkDVClosed","closed","refreshScores","setTimeout","submission_id","refreshStartTime","Date","getTime","submission","requestDuration","location","show"],"mappings":"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","sourcesContent":["/**\n * Javascript controller for opening the originality report viewreport\n\n * @package plagiarism_turnitin\n * @copyright 2019 Turnitin\n * @author Charlotte Spinks <cspinks@turnitin.com>\n * @module plagiarism_turnitin/open_viewer\n */\n\ndefine(['jquery'], function($) {\n    return {\n        origreport_open: function() {\n            var that = this;\n            $(document).on('click', '.pp_origreport_open', function() {\n                var classList = $(this).attr('class').replace(/\\s+/,' ').split(' ');\n\n                for (var i = 0; i < classList.length; i++) {\n                    if (classList[i].indexOf('origreport_') !== -1 && classList[i] != 'pp_origreport_open') {\n                        var classStr = classList[i].split(\"_\");\n                        that.openDV(\"origreport\", classStr[1], classStr[2]);\n                    }\n                }\n             });\n        },\n\n        grademark_open: function() {\n            var that = this;\n            $(document).on('click', '.pp_grademark_open', function() {\n                var classList = $(this).attr('class').replace(/\\s+/,' ').split(' ');\n\n                for (var i = 0; i < classList.length; i++) {\n                    if (classList[i].indexOf('grademark_') !== -1 && classList[i] != 'pp_grademark_open') {\n                        var classStr = classList[i].split(\"_\");\n                        that.openDV(\"grademark\", classStr[1], classStr[2]);\n                    }\n                }\n            });\n        },\n\n        // Open the DV in a new window in such a way as to not be blocked by popups.\n        openDV: function(dvtype, submissionid, coursemoduleid) {\n          var that = this;\n          var dvWindow = window.open('', 'turnitin_viewer');\n\n          var loading = '<div class=\"tii_dv_loading\" style=\"text-align:center;\">';\n          var icon = '/plagiarism/turnitin/pix/turnitin-icon.png';\n          loading += '<img src=\"' + M.cfg.wwwroot + icon +'\" style=\"width:100px; height: 100px\">';\n          loading += '<p style=\"font-family: Arial, Helvetica, sans-serif;\">' + M.str.plagiarism_turnitin.loadingdv + '</p>';\n          loading += '</div>';\n          $(dvWindow.document.body).html(loading);\n\n          // Get html to launch DV.\n          $.ajax({\n              type: \"POST\",\n              url: M.cfg.wwwroot + \"/plagiarism/turnitin/ajax.php\",\n              dataType: \"json\",\n              data: {\n                  action: \"get_dv_html\",\n                  submissionid: submissionid,\n                  dvtype: dvtype,\n                  cmid: coursemoduleid,\n                  sesskey: M.cfg.sesskey\n              },\n              success: function(data) {\n                  $(dvWindow.document.body).html(loading + data);\n                  dvWindow.document.forms[0].submit();\n                  dvWindow.document.close();\n\n                  that.checkDVClosed(submissionid, coursemoduleid, dvWindow);\n              }\n          });\n        },\n\n        checkDVClosed: function(submissionid, coursemoduleid, dvWindow) {\n            var that = this;\n\n            if (dvWindow.closed) {\n                that.refreshScores(submissionid, coursemoduleid);\n            } else {\n                setTimeout( function(){\n                    that.checkDVClosed(submissionid, coursemoduleid, dvWindow);\n                }, 500);\n            }\n        },\n\n        refreshScores: function(submission_id, coursemoduleid) {\n            var refreshStartTime = new Date().getTime();\n            $.ajax({\n                type: \"POST\",\n                url: M.cfg.wwwroot + \"/plagiarism/turnitin/ajax.php\",\n                dataType: \"json\",\n                data: {\n                    action: \"update_grade\",\n                    submission: submission_id,\n                    cmid: coursemoduleid,\n                    sesskey: M.cfg.sesskey\n                },\n                success: function() {\n                    var requestDuration = new Date().getTime() - refreshStartTime;\n                    if (requestDuration < 3000 || !$('.turnitin_score_refresh_alert').length) {\n                        window.location = window.location + '';\n                    } else {\n                        $('.turnitin_score_refresh_alert').show();\n                    }\n                }\n            });\n        }\n    };\n});\n"],"file":"open_viewer.min.js"}